<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        body {
            background-color: #909090;
        }
    </style>
</head>
<body>
    <h1>Encrypt/Decrypt</h1>
    <p>Using WCA</p>
</body>
<script>

const myData = '0123456789abcdefghijklmnopqrstuvwxyz';
const myIv = 'foo';
const myIvExpanded = myIv + myIv + myIv + myIv;
const iv = new TextEncoder('utf-8').encode(myIvExpanded);

const keyInput = 'abcdefghabcdefghabcdefgh';

async function makeKey(keyInput) {
    const keyBase64 = btoa(keyInput);
    const keyBuffer = new Uint8Array(keyBase64.length);
    for (let i = 0; i < keyBase64.length; i++) {
        keyBuffer[i] = String.fromCharCode(keyBase64.charCodeAt(i));
    }
    const cryptoKey = await window.crypto.subtle.importKey(
        'raw',
        keyBuffer,
        { name: 'AES-GCM', length: 256 },
        true,
        ['encrypt', 'decrypt']
    );
    return cryptoKey;
};

async function encryptData(message, keyInput) {
    console.log('plaintext data: ', myData);
    const resolvedKey = await makeKey(keyInput);
    const encodedMessage = new TextEncoder().encode(message);
    const encryptedData = await window.crypto.subtle.encrypt(
        {
            name: "AES-GCM",
            iv: iv
        },
        resolvedKey,
        encodedMessage
    );
    return encryptedData;
}

// window.crypto.subtle.generateKey(
//     {
//         name: "AES-GCM",
//         length: 256,
//     },
//     true,
//     ["encrypt", "decrypt"]
// )
// .then((key) => {
//         encryptData(myData, key);
//     })
// .catch((error) => {
//     console.error("Error generating key:", error);
// });


// Decrypt data
async function decryptData(key, encrypted) {
    const resolvedKey = await makeKey(key);

    const decryptedData = await window.crypto.subtle.decrypt(
        {
        name: "AES-GCM",
        iv: iv
        },
        resolvedKey,
        encrypted
        // encDataBuffer
    );
    return decryptedData;
}

async function getDecryptedData(myData, keyInput) {
    const encData = await encryptData(myData, keyInput);
    const textDecoder = new TextDecoder('utf-8');
    encDataString = textDecoder.decode(encData);
    console.log('encoded data: ', encDataString);
    const decData = decryptData(keyInput, encData)
            .then((clearData) => {
                const textDecoder = new TextDecoder('utf-8');
                decodedData = textDecoder.decode(clearData);
                console.log('decoded data: ', decodedData);
            });
}

getDecryptedData(myData, keyInput);

</script>
</html>